#!/usr/bin/python



prefix = "0001FFFFFFFFFFFFFFFF003031300D060960864801650304020105C3"
len_prefix_bits = len(prefix)*4
offset_prefix = 0
middle = "04FF"
offset_middle = 190/2
message = "48ACE9B7BC30CB37338419F7716D4E9F50AA0AD2A425BCF38C2A11669F85CFD5"
offset_message = 224

total_length_bits = 8*(offset_message+len(message)/2) #normalement meme nombre de bits que N, c'est a dire ici 2048

#on cherche A,B et D tels que (prefix+B)*2^(3X)*2^D = A^3 = (C*(2^X))^3 = C^3 * 2^(3X)

def find_cube_root(n):
    m = 0
    M = n
    while m<M:
        cur = (m+M)//2
        if cur**3 < n:
            m = cur+1
        else:
            M = cur
    return m

import random

def find_cube_root_prefix(hex_prefix, total_length_bits) :
    to_compare_with = ''
    stillNull = True
    for i in range(len(hex_prefix)):
        if hex_prefix[i]=='0' and stillNull:
            pass
        elif hex_prefix[i] != '0':
            stillNull = False
        if not stillNull:
            to_compare_with += hex_prefix[i]
    to_compare_with = to_compare_with.lower()

    len_prefix_bits = len(hex_prefix)*4
    ok = False
    n_unknown_bits = 10
    while not ok and n_unknown_bits<3000:
        tmp = int(hex_prefix,16)*(2**n_unknown_bits)
        for j in range((total_length_bits-len_prefix_bits-n_unknown_bits)%3):
            tmp *= 2
        cb_sqrt = find_cube_root(int(tmp))*(2**((total_length_bits-len_prefix_bits-n_unknown_bits)//3))
        to_compare = hex(cb_sqrt*cb_sqrt*cb_sqrt).replace('0x','').replace('L','')
        if to_compare[:len(to_compare_with)] == to_compare_with:
            print("Prefix cube root found with "+str(n_unknown_bits)+" additional bits")
            break
        n_unknown_bits += 5
    return cb_sqrt

def forge_odd(hash, hash_len_bits):
    y = 1
    mask = 1
    for i in range(1, hash_len_bits):
        mask = mask | (1<<i)
        if (((y*y*y)^hash) & mask) != 0:
            y = y + (1<<i)
    return y

import math

def forge_even(hash, hash_len_bits, N):
    odd_hash = (hash+N) & ((1<<hash_len_bits)-1)
    residual = forge_odd(odd_hash, hash_len_bits)
    y = 0
    for i in range(2048//3, hash_len_bits, -1):
        y = y | (1 << i)
        c = (y + residual)*(y + residual)*(y + residual)
        if (c > N) and (c < (2 * N)):
            break
        elif c > (2 * N):
            y = y & (~(1 << i))
    return (y + residual)

def forge_suffix(hex_hash, hash_len_bits, N):
    hash = int(hex_hash,16)
    if (h & 1) == 0:
        return forge_even(hash, hash_len_bits, N)
    else:
        return forge_odd(hash, hash_len_bits)

cube_root = find_cube_root_prefix(prefix, total_length_bits)

suffix = int(message,16)
cube_root = forge_odd(suffix,len(message)*4)
print(cube_root,hex(cube_root*cube_root*cube_root))


message = "48ACE9B7BC30CB37338419F7716D4E9F50AA0AD2A425BCF38C2A11669F85CFD6"
suffix = int(message,16)
N = (1<<1024)+(1<<9)-(1<<39)-1
cube_root = forge_even(suffix,len(message)*4,N)
print(cube_root,hex(pow(cube_root,3,N)))


N = int("00:d2:2a:7b:13:ee:c0:eb:e6:6e:09:10:4e:d3:30:bb:db:3a:73:d7:ab:2c:9d:19:8b:ac:0c:de:e5:08:ff:8c:4b:07:22:e7:98:b0:06:1e:16:64:a0:45:2d:8f:c4:af:34:85:a7:d5:c8:56:0c:76:16:74:31:18:21:08:3a:b2:a2:18:dd:2a:9f:bc:7b:af:ba:92:9b:7f:10:b5:76:5b:ac:88:4e:f2:da:e3:ef:27:df:f7:75:fe:4a:6a:ae:04:3e:94:b9:7a:43:4a:1d:f8:c1:d7:d4:3c:62:69:c2:af:fa:44:ed:1b:09:c9:5f:59:38:32:bc:b1:0d:07:d4:22:7c:e3:f0:36:9b:c1:21:85:fa:8f:a0:52:da:91:d4:04:df:5e:5f:61:b6:6e:9b:00:af:c8:b1:96:f4:2b:cf:b6:00:2e:5d:ff:aa:03:d7:10:68:ab:a3:64:5a:67:a1:6b:95:74:7d:ce:80:4c:eb:55:55:3d:23:68:6f:33:28:04:ba:60:07:09:b6:a0:c2:3b:5c:6c:2a:74:6f:44:b6:86:88:62:a4:4b:11:90:23:c5:a2:9b:75:f0:98:5e:8c:bf:ea:54:f0:13:be:a1:73:26:f5:c0:5f:8d:6e:8a:3a:97:19:51:ff:21:ca:d7:66:51:85:dd:29:a5:c3:80:90:88:9b".replace(':',''),16)
message = "E2 74 75 54 E7 DC B2 C9 77 97 93 E3 44 BE AF 80 D9 1D BD C7 67 73 6C B1 84 62 1B 70 18 B2 D8 5A".replace(' ','')
suffix = int(message,16)
cube_root = forge_even(suffix,len(message)*4,N)
print(cube_root,hex(pow(cube_root,3,N)))
